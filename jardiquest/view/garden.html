{% extends "_base.html" %}
{% set active='garden' %}
{% include "_navbar.html" %}
{% block content %}

<title>Profil</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/view/garden.css') }}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="{{ url_for('static', filename='js/flash_messages_modal.js') }}"></script>

{% with messages = get_flashed_messages(category_filter=["error"]) %}
    {% if messages %}
    <div id="flash_messages">
        <p id="category_message" hidden>Erreur</p>
        <p id="flash_message" hidden>{{ messages[0] }}</p>
        <div id="flash_message_buttons" hidden>
            <button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
        </div>
    </div>
    {% endif %}
{% endwith %}

    
<div class="portal-container">
    <div class="handler-display-data">
        <div class="top">
            <div class="attributs">
                <div>
                    {% set name=jardin.name %}
                
                    {% if name is none %}
                        {% set name='' %}
                    {% endif %}
                    {% if name|length == 0 %}
                        <b class="brown-orange-style">Mon jardin :</b>
                        <span>Vous n'avez pas de jardin</span>
                    </div>
                    {% else %}
                        <b class="brown-orange-style">Mon jardin :</b>
                        <span>{{jardin.name}}</span>
                        <br>
                        <b class="brown-orange-style">Monnaie :</b>
                        <span>{{jardin.moneyName}}</span>
                    </div>
                    <div>
                        <b class="brown-orange-style">Ville :</b>
                        <span>{{jardin.ville}}</span>
                        <br>
                        <b class="brown-orange-style">Adresse :</b>
                        <span>{{jardin.adresse}}</span>
                    </div>
                    <div>
                        <b class="brown-orange-style">Role :</b>
                        <span>{{user.role}}</span>
                    </div>
                    {% endif %}
            </div>
            <div class="right">

                {% set idJardin=user.idJardin %}
                
                {% if idJardin is none %}
                    {% set idJardin='' %}
                {% endif %}

                <!-- To create a garden you musn't have garden -->
                {% if idJardin|length == 0 %}
                    <button class="button_edit"><a href="{{url_for('controller.new_garden')}}">Nouveau</a></button>
                {% endif %}
            
                <!-- To modify it must be your own garden -->
                {% if user.role == 'Proprietaire' %}
                    {% if idJardin|length != 0 %}
                        <button class="button_edit"><a href="{{url_for('controller.modify_garden')}}">Modifier</a></button>
                    {% endif %}
                {% endif %}

                <!-- To leave a garden we must be a participant that is in a garden -->
                {% if idJardin|length != 0 %}
                        {% if user.role == 'Participant' %}
                        <button class="button_edit">
                            <a href="{{url_for('controller.leave')}}">Quitter</a>
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div>
            <span>
                <b class="brown-orange-style">Trouver un autre jardin :</b> <br>
            </span>
            <form method="POST" class="display_form">
                <input class="input" type="text" name="filtreNom" placeholder="Nom"></input>
                <input class="input" type="text" name="filtreDescription" placeholder="Description"></input>
                <input class="input" type="text" name="filtreMonnaie" placeholder="Monnaie"></input>
                <input class="input" type="text" name="filtreVille" placeholder="Ville"></input>
                <input class="input" type="text" name="filtreAdresse" placeholder="Adresse"></input>
                <button class="button" type="submit">Search</button>
            </form>
            <table id="table" class="table-all">
                <thead>
                    <tr>
                        <th>Nom du jardin</th>
                        <th>Description</th>
                        <th>Monnaie</th>
                        <th>Ville</th>
                        <th>Adresse</th>
                        {% if user.role == 'Participant' %}
                            <th>Choisir</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="body">
                </tbody>
            </table>
            <div class="find"><button onclick="previousPage()">Précedent</button><p id="resultats"></p><button onclick="nextPage()">Suivant</button></div>
        </div> 
    </div>
</div>
  
<!-- Modal -->
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
      
    <!-- Modal content-->
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="brown-orange-style">Changer de jardin</h4>
            <p id="idGarden" hidden></p>
        </div>
        <div class="modal-body">
            <p>Voulez vous vraiment choisir ce jardin ?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
            <button type="button" onclick="changeGarden()" class="btn btn-default">Choisir</button>
        </div>
    </div>        
</div>

<script>
    var init = -10
    var counts = JSON.parse('{{jsTable|tojson|safe}}')
    const sizeCounts = '{{total}}'
    const role = '{{user.role}}'
    numberItems = 10
    nextPage()

    function changeId(id) {
        var element = document.getElementById('idGarden');
        element.innerHTML = id;
    }

    function changeGarden(){
        var element = document.getElementById('idGarden');
        link = '/change/'+element.innerHTML
        window.location = link;
    }

    function emptyTable(){
        elt = document.getElementById('body')
        elt.innerHTML = ""
    }
    
    // next page is used to display the nexts rows in the table
    function nextPage(){
        if(init+numberItems<sizeCounts){
            init = init + numberItems
            emptyTable()
            elt = document.getElementById('body')
            liste = counts.slice(init,init + numberItems)
            changeResultat(init+numberItems)
            liste.forEach(
                element => addRow(element,elt)
                );
        }
    }

    function previousPage(){
        if(init-numberItems>=0){
            emptyTable()
            elt = document.getElementById('body')
            listePrev = counts.slice(init-numberItems,init)
            changeResultat(init)
            listePrev.forEach(
                element => addRow(element,elt)
                );
            init = init-numberItems
        }
    }

    function chooseButton(row){
        const choose = '<button type="button" onclick="changeId(\''+row[5]+'\')" data-toggle="modal" data-target="#myModal">Choisir</button>'
        return choose
    }

    function changeResultat(displayed){
        res = document.getElementById('resultats')
        res.innerHTML = 'Résultats : '+ Math.min(displayed,sizeCounts) +'/'+ sizeCounts
    }

    // use to insert a row in the table
    function addRow(row,elt) {

        if(role=='Participant'){
            if(!row[5].includes('button type="button"')){
                choose = chooseButton(row)
                row.pop()
                row.push(choose)
            }
        }else{
            row = row.slice(0,5)
        }

        var ligne = elt.insertRow(-1);

        row.forEach(
            element => ligne.insertCell(-1).innerHTML = element,
            );

        var table = document.getElementById('body');
        table.setAttribute("class", "cells");
    }
</script>
{% endblock %}